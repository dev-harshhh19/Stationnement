@page
@model Stationnement.Web.Pages.Dashboard.ReservationsModel
@{
    ViewData["Title"] = "My Reservations";
    Layout = "_DashboardLayout";
}

<div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mb-6">
    <div>
        <h2 class="text-xl font-semibold text-gray-900">My Reservations</h2>
        <p class="text-gray-500 text-sm">View and manage your parking reservations</p>
    </div>
    <a href="/Dashboard/Book" class="bg-primary-600 hover:bg-primary-700 text-white font-medium py-2 px-4 rounded-xl transition text-center">
        + New Booking
    </a>
</div>

<!-- Tabs -->
<div class="overflow-x-auto -mx-4 px-4 mb-6">
    <div class="flex space-x-2 min-w-max">
        <button onclick="filterReservations('all')" class="tab-btn px-3 py-2 rounded-lg font-medium text-sm bg-primary-100 text-primary-700 whitespace-nowrap" id="tabAll">All</button>
        <button onclick="filterReservations('confirmed')" class="tab-btn px-3 py-2 rounded-lg font-medium text-sm text-gray-600 whitespace-nowrap" id="tabConfirmed">Upcoming</button>
        <button onclick="filterReservations('active')" class="tab-btn px-3 py-2 rounded-lg font-medium text-sm text-gray-600 whitespace-nowrap" id="tabActive">Active</button>
        <button onclick="filterReservations('completed')" class="tab-btn px-3 py-2 rounded-lg font-medium text-sm text-gray-600 whitespace-nowrap" id="tabCompleted">Completed</button>
        <button onclick="filterReservations('cancelled')" class="tab-btn px-3 py-2 rounded-lg font-medium text-sm text-gray-600 whitespace-nowrap" id="tabCancelled">Cancelled</button>
    </div>
</div>

<div class="bg-white rounded-xl shadow-sm" id="reservationsList">
    <div class="p-8 text-center text-gray-500">Loading reservations...</div>
</div>

<!-- Reservation Detail Modal -->
<div id="detailModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-40 hidden">
    <div class="bg-white rounded-2xl max-w-lg w-full mx-4 max-h-[90vh] overflow-y-auto">
        <!-- Header -->
        <div class="bg-gradient-to-r from-primary-600 to-primary-700 text-white p-6 rounded-t-2xl">
            <div class="flex items-center justify-between">
                <h3 class="text-xl font-bold">Reservation Details</h3>
                <button onclick="closeDetailModal()" class="p-1 hover:bg-white/20 rounded-lg transition">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>
            <p class="text-primary-100 text-sm mt-1" id="detailQrCode">Code: --------</p>
        </div>
        

        
        <!-- Status Badge -->
        <div class="px-6 py-4 border-b flex items-center justify-between">
            <span id="detailStatusBadge" class="px-3 py-1 rounded-full text-sm font-semibold bg-blue-100 text-blue-700">Confirmed</span>
            <span id="detailTimeRemaining" class="text-sm text-gray-500"></span>
        </div>
        
        <!-- Details Grid -->
        <div class="p-6 space-y-4">
            <div class="grid grid-cols-2 gap-4">
                <div class="bg-gray-50 rounded-xl p-4">
                    <p class="text-xs text-gray-500 uppercase tracking-wide mb-1">Location</p>
                    <p class="font-semibold text-gray-900" id="detailLocation">-</p>
                </div>
                <div class="bg-gray-50 rounded-xl p-4">
                    <p class="text-xs text-gray-500 uppercase tracking-wide mb-1">Slot</p>
                    <p class="font-semibold text-gray-900" id="detailSlot">-</p>
                </div>
            </div>
            
            <div class="grid grid-cols-2 gap-4">
                <div class="bg-gray-50 rounded-xl p-4">
                    <p class="text-xs text-gray-500 uppercase tracking-wide mb-1">Date</p>
                    <p class="font-semibold text-gray-900" id="detailDate">-</p>
                </div>
                <div class="bg-gray-50 rounded-xl p-4">
                    <p class="text-xs text-gray-500 uppercase tracking-wide mb-1">Time</p>
                    <p class="font-semibold text-gray-900" id="detailTime">-</p>
                </div>
            </div>
            
            <div class="grid grid-cols-2 gap-4">
                <div class="bg-gray-50 rounded-xl p-4">
                    <p class="text-xs text-gray-500 uppercase tracking-wide mb-1">Duration</p>
                    <p class="font-semibold text-gray-900" id="detailDuration">-</p>
                </div>
                <div class="bg-gray-50 rounded-xl p-4">
                    <p class="text-xs text-gray-500 uppercase tracking-wide mb-1">Vehicle</p>
                    <p class="font-semibold text-gray-900" id="detailVehicle">-</p>
                </div>
            </div>
            
            <div class="bg-gray-50 rounded-xl p-4">
                <p class="text-xs text-gray-500 uppercase tracking-wide mb-1">Vehicle Plate</p>
                <p class="font-semibold text-gray-900" id="detailPlate">-</p>
            </div>
            
            <!-- Pricing Section -->
            <div class="bg-primary-50 rounded-xl p-4 border border-primary-100">
                <p class="text-xs text-primary-600 uppercase tracking-wide mb-2">Payment Summary</p>
                <div class="flex justify-between items-center">
                    <span class="text-gray-700">Total Amount</span>
                    <span class="text-2xl font-bold text-primary-700" id="detailAmount">‚Çπ0.00</span>
                </div>
            </div>
        </div>
        
        <!-- Cancellation Section -->
        <div class="px-6 pb-6" id="cancellationSection">
            <div id="cancellationEnabled" class="space-y-4">
                <div class="bg-amber-50 border border-amber-200 rounded-lg p-4">
                    <div class="flex items-center gap-2 text-amber-700 mb-2">
                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/></svg>
                        <span class="font-medium">10% Cancellation Fee Applies</span>
                    </div>
                    <p class="text-sm text-amber-600">Refund amount: <span id="detailRefund" class="font-semibold">‚Çπ0.00</span></p>
                </div>
                
                <!-- Refund Method Selection -->
                <div class="bg-gray-50 rounded-xl p-4">
                    <p class="text-sm font-semibold text-gray-700 mb-3">Select Refund Method</p>
                    <div class="space-y-2">
                        <label class="flex items-center p-3 bg-white rounded-lg border-2 border-primary-500 cursor-pointer refund-option" data-method="UPI">
                            <input type="radio" name="refundMethod" value="UPI" class="w-4 h-4 text-primary-600" checked onchange="toggleUpiInput()">
                            <div class="ml-3 flex items-center gap-2">
                                <span class="text-xl">üí≥</span>
                                <div>
                                    <span class="font-medium text-gray-900">UPI</span>
                                    <p class="text-xs text-gray-500">Instant refund to your UPI ID</p>
                                </div>
                            </div>
                        </label>
                        <label class="flex items-center p-3 bg-white rounded-lg border border-gray-200 cursor-pointer refund-option" data-method="Bank Transfer">
                            <input type="radio" name="refundMethod" value="Bank Transfer" class="w-4 h-4 text-primary-600" onchange="toggleUpiInput()">
                            <div class="ml-3 flex items-center gap-2">
                                <span class="text-xl">üè¶</span>
                                <div>
                                    <span class="font-medium text-gray-900">Bank Transfer</span>
                                    <p class="text-xs text-gray-500">2-3 business days to your account</p>
                                </div>
                            </div>
                        </label>
                        <label class="flex items-center p-3 bg-white rounded-lg border border-gray-200 cursor-pointer refund-option" data-method="Wallet">
                            <input type="radio" name="refundMethod" value="Wallet" class="w-4 h-4 text-primary-600" onchange="toggleUpiInput()">
                            <div class="ml-3 flex items-center gap-2">
                                <span class="text-xl">üëõ</span>
                                <div>
                                    <span class="font-medium text-gray-900">Stationnement Wallet</span>
                                    <p class="text-xs text-gray-500">Instant credit, use for future bookings</p>
                                </div>
                            </div>
                        </label>
                    </div>
                    
                    <!-- UPI ID Input (visible only when UPI selected) -->
                    <div id="upiIdSection" class="mt-3 pt-3 border-t border-gray-200">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Enter UPI ID for refund</label>
                        <input type="text" id="refundUpiId" placeholder="yourname@@upi" 
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500 text-gray-900"
                            pattern="[a-zA-Z0-9._-]+@@[a-zA-Z]+" required>
                        <p class="text-xs text-gray-500 mt-1">Example: username@@paytm, name@@oksbi, phone@@ybl</p>
                    </div>
                </div>
                
                <button id="cancelFromDetailBtn" onclick="cancelFromDetail()" class="w-full py-3 bg-red-600 text-white rounded-xl font-semibold hover:bg-red-700 transition flex items-center justify-center gap-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                    </svg>
                    Cancel Reservation
                </button>
            </div>
            
            <div id="cancellationBlocked" class="hidden">
                <div class="bg-gray-100 border border-gray-200 rounded-lg p-4 text-center">
                    <div class="w-12 h-12 bg-gray-300 rounded-full flex items-center justify-center mx-auto mb-3">
                        <svg class="w-6 h-6 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/>
                        </svg>
                    </div>
                    <p class="font-medium text-gray-700">Cancellation Not Available</p>
                    <p class="text-sm text-gray-500 mt-1" id="blockedReason">Less than 1 hour until start time</p>
                </div>
            </div>
            
            <div id="alreadyCancelledSection" class="hidden">
                <div class="bg-red-50 border border-red-200 rounded-lg p-4 text-center">
                    <p class="font-medium text-red-700">This reservation has been cancelled</p>
                    <p class="text-sm text-red-600 mt-1" id="refundedAmount"></p>
                </div>
            </div>
            
            <div id="completedSection" class="hidden">
                <div class="bg-green-50 border border-green-200 rounded-lg p-4 text-center">
                    <p class="font-medium text-green-700">This reservation has been completed</p>
                    <p class="text-sm text-green-600 mt-1">Thank you for using Stationnement!</p>
                </div>
            </div>
        </div>
        
        <!-- Actions -->
        <div class="px-6 pb-6 flex gap-3">
            <a id="viewBarcodeLink" href="#" target="_blank" class="flex-1 py-3 bg-primary-600 text-white rounded-xl font-semibold hover:bg-primary-700 transition text-center">
                View Barcode
            </a>
            <button onclick="closeDetailModal()" class="flex-1 py-3 border border-gray-300 text-gray-700 rounded-xl font-semibold hover:bg-gray-50 transition">
                Close
            </button>
        </div>
    </div>
</div>

<!-- Cancel Confirmation Modal -->
<div id="cancelModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-2xl p-6 max-w-md w-full mx-4">
        <h3 class="text-lg font-semibold text-gray-900 mb-2">Confirm Cancellation</h3>
        <p class="text-gray-600 mb-4" id="cancelModalText">Are you sure you want to cancel this reservation?</p>
        
        <div class="bg-amber-50 border border-amber-200 rounded-lg p-4 mb-4">
            <div class="flex items-center gap-2 text-amber-700">
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/></svg>
                <span class="font-medium">10% Cancellation Fee Applies</span>
            </div>
            <p class="text-sm text-amber-600 mt-1">Refund amount: <span id="refundPreview" class="font-semibold">‚Çπ0.00</span></p>
        </div>
        
        <div class="flex gap-3">
            <button onclick="closeCancelModal()" class="flex-1 py-2 border border-gray-300 text-gray-700 rounded-lg font-medium hover:bg-gray-50">Keep Reservation</button>
            <button onclick="confirmCancel()" id="confirmCancelBtn" class="flex-1 py-2 bg-red-600 text-white rounded-lg font-medium hover:bg-red-700">Cancel & Refund</button>
        </div>
    </div>
</div>

@section Scripts {
<script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
<script>
let allReservations = [];
let reservationToCancel = null;
let statusUpdateInterval = null;

document.addEventListener('DOMContentLoaded', async function() {
    await loadReservations();
    
    // Update reservation statuses every 30 seconds to show active reservations in real-time
    statusUpdateInterval = setInterval(updateReservationStatuses, 30000);
});

// Update reservation statuses in real-time without reloading from server
function updateReservationStatuses() {
    const now = new Date();
    let hasChanges = false;
    
    allReservations.forEach(r => {
        const start = new Date(r.startTime);
        const end = new Date(r.endTime);
        const currentDisplayStatus = r.displayStatus || r.status;
        
        // Determine actual status based on current time
        let newDisplayStatus;
        let newStatusColor;
        
        if (r.status === 'confirmed' && start <= now && end >= now) {
            newDisplayStatus = 'active';
            newStatusColor = 'bg-green-100 text-green-700';
        } else if (r.status === 'confirmed' && start > now) {
            newDisplayStatus = 'upcoming';
            newStatusColor = 'bg-blue-100 text-blue-700';
        } else if (r.status === 'confirmed' && end < now) {
            newDisplayStatus = 'completed';
            newStatusColor = 'bg-gray-100 text-gray-700';
        } else {
            newDisplayStatus = r.status;
            newStatusColor = {
                active: 'bg-green-100 text-green-700',
                confirmed: 'bg-blue-100 text-blue-700',
                completed: 'bg-gray-100 text-gray-700',
                cancelled: 'bg-red-100 text-red-700'
            }[r.status] || 'bg-gray-100 text-gray-700';
        }
        
        // Update if status changed
        if (currentDisplayStatus !== newDisplayStatus) {
            r.displayStatus = newDisplayStatus;
            r.statusColor = newStatusColor;
            hasChanges = true;
        }
    });
    
    // Re-render if there were changes
    if (hasChanges) {
        const currentFilter = document.querySelector('.tab-btn.bg-primary-100');
        if (currentFilter) {
            const filterText = currentFilter.textContent.toLowerCase();
            let filterStatus = 'all';
            if (filterText.includes('upcoming')) filterStatus = 'confirmed';
            else if (filterText.includes('active')) filterStatus = 'active';
            else if (filterText.includes('completed')) filterStatus = 'completed';
            else if (filterText.includes('cancelled')) filterStatus = 'cancelled';
            filterReservations(filterStatus);
        } else {
            renderReservations(allReservations);
        }
    }
}

async function loadReservations() {
    try {
        const response = await Auth.apiRequest('/api/reservation');
        const data = await response.json();
        if (data.success && data.data) {
            // Show all reservations with valid IDs
            allReservations = data.data.filter(r => r.id);
            
            // Auto-update status: if start time has passed and status is 'confirmed', mark as 'active'
            const now = new Date();
            allReservations = allReservations.map(r => {
                const start = new Date(r.startTime);
                const end = new Date(r.endTime);
                
                // Determine actual status based on current time
                if (r.status === 'confirmed' && start <= now && end >= now) {
                    r.displayStatus = 'active'; // Display as active but keep original status for backend
                    r.statusColor = 'bg-green-100 text-green-700';
                } else if (r.status === 'confirmed' && start > now) {
                    r.displayStatus = 'upcoming';
                    r.statusColor = 'bg-blue-100 text-blue-700';
                } else if (r.status === 'confirmed' && end < now) {
                    r.displayStatus = 'completed';
                    r.statusColor = 'bg-gray-100 text-gray-700';
                } else {
                    r.displayStatus = r.status;
                    r.statusColor = {
                        active: 'bg-green-100 text-green-700',
                        confirmed: 'bg-blue-100 text-blue-700',
                        completed: 'bg-gray-100 text-gray-700',
                        cancelled: 'bg-red-100 text-red-700'
                    }[r.status] || 'bg-gray-100 text-gray-700';
                }
                
                return r;
            });
            
            renderReservations(allReservations);
        } else {
            document.getElementById('reservationsList').innerHTML = '<div class="p-8 text-center text-gray-500">No reservations yet. Book parking to see your reservations here.</div>';
        }
    } catch (error) {
        document.getElementById('reservationsList').innerHTML = '<div class="p-8 text-center text-gray-500">No reservations yet. Book parking to see your reservations here.</div>';
    }
}

function filterReservations(status) {
    document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.remove('bg-primary-100', 'text-primary-700');
        btn.classList.add('text-gray-600');
    });
    const activeTab = document.getElementById('tab' + status.charAt(0).toUpperCase() + status.slice(1));
    if (activeTab) {
        activeTab.classList.add('bg-primary-100', 'text-primary-700');
        activeTab.classList.remove('text-gray-600');
    }
    
    // Filter by displayStatus for 'active' and 'completed', by status for others
    let filtered;
    if (status === 'all') {
        filtered = allReservations;
    } else if (status === 'active') {
        filtered = allReservations.filter(r => (r.displayStatus || r.status) === 'active');
    } else if (status === 'completed') {
        filtered = allReservations.filter(r => (r.displayStatus || r.status) === 'completed');
    } else {
        filtered = allReservations.filter(r => (r.displayStatus || r.status) === status);
    }
    
    renderReservations(filtered);
}

function renderReservations(reservations) {
    const container = document.getElementById('reservationsList');
    if (reservations.length === 0) {
        container.innerHTML = '<div class="p-8 text-center text-gray-500">No reservations found</div>';
        return;
    }
    
    container.innerHTML = reservations.map(r => {
        const start = new Date(r.startTime);
        const end = new Date(r.endTime);
        
        const statusDisplay = r.displayStatus || r.status;
        const statusColor = r.statusColor || 'bg-gray-100 text-gray-700';
        
        return `
        <div class="p-4 border-b last:border-b-0 hover:bg-gray-50 cursor-pointer transition" onclick="openDetailModal('${r.id}')">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <div class="w-12 h-12 bg-primary-100 rounded-lg flex items-center justify-center">
                        <svg class="w-6 h-6 text-primary-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                        </svg>
                    </div>
                    <div>
                        <p class="font-medium text-gray-900">${r.locationName || 'Parking'}</p>
                        <p class="text-sm text-gray-500">${r.qrCode || 'N/A'} ‚Ä¢ Slot ${r.slotCode || 'N/A'}</p>
                        <p class="text-sm text-gray-500">${start.toLocaleDateString()} ‚Ä¢ ${start.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'})} - ${end.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'})}</p>
                        ${r.vehiclePlate ? `<p class="text-xs text-gray-400 mt-1">üöó ${r.vehiclePlate}</p>` : ''}
                    </div>
                </div>
                <div class="text-right flex items-center gap-3">
                    <div>
                        <span class="px-2 py-1 rounded-full text-xs font-medium ${statusColor}">${statusDisplay}</span>
                        <p class="text-lg font-semibold text-gray-900 mt-1">‚Çπ${r.totalAmount?.toFixed(2) || '0.00'}</p>
                        ${r.status === 'cancelled' && r.refundAmount > 0 ? `<p class="text-xs text-green-600">Refund: ‚Çπ${r.refundAmount.toFixed(2)}</p>` : ''}
                    </div>
                    <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                    </svg>
                </div>
            </div>
        </div>`;
    }).join('');
}

let selectedReservation = null;

function openDetailModal(reservationId) {
    const r = allReservations.find(res => res.id === reservationId);
    if (!r) return;
    
    selectedReservation = r;
    const start = new Date(r.startTime);
    const end = new Date(r.endTime);
    const now = new Date();
    const hoursUntilStart = (start - now) / (1000 * 60 * 60);
    const durationHours = (end - start) / (1000 * 60 * 60);
    
    // Fill in details
    const qrCode = r.qrCode || r.id || 'N/A';
    document.getElementById('detailQrCode').textContent = `Code: ${qrCode}`;
    document.getElementById('detailLocation').textContent = r.locationName || 'N/A';
    document.getElementById('detailSlot').textContent = r.slotCode || 'N/A';
    document.getElementById('detailDate').textContent = start.toLocaleDateString('en-IN', { weekday: 'short', day: 'numeric', month: 'short', year: 'numeric' });
    document.getElementById('detailTime').textContent = `${start.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'})} - ${end.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'})}`;
    document.getElementById('detailDuration').textContent = `${durationHours.toFixed(1)} hours`;
    document.getElementById('detailVehicle').textContent = (r.vehicleType || 'Standard').charAt(0).toUpperCase() + (r.vehicleType || 'standard').slice(1);
    document.getElementById('detailPlate').textContent = r.vehiclePlate || 'Not provided';
    document.getElementById('detailAmount').textContent = `‚Çπ${(r.totalAmount || 0).toFixed(2)}`;
    document.getElementById('viewBarcodeLink').href = `/api/payment/barcode/${r.id}`;
    

    
    // Calculate refund
    const refundAmount = (r.totalAmount || 0) * 0.90;
    document.getElementById('detailRefund').textContent = `‚Çπ${refundAmount.toFixed(2)}`;
    
    // Status badge
    const statusDisplay = r.displayStatus || r.status;
    const statusColors = {
        active: 'bg-green-100 text-green-700',
        upcoming: 'bg-blue-100 text-blue-700',
        confirmed: 'bg-blue-100 text-blue-700',
        completed: 'bg-gray-100 text-gray-700',
        cancelled: 'bg-red-100 text-red-700'
    };
    document.getElementById('detailStatusBadge').className = `px-3 py-1 rounded-full text-sm font-semibold ${statusColors[statusDisplay] || 'bg-gray-100 text-gray-700'}`;
    document.getElementById('detailStatusBadge').textContent = statusDisplay.charAt(0).toUpperCase() + statusDisplay.slice(1);
    
    // Time remaining
    if (hoursUntilStart > 0 && r.status === 'confirmed') {
        if (hoursUntilStart >= 24) {
            document.getElementById('detailTimeRemaining').textContent = `Starts in ${Math.floor(hoursUntilStart / 24)} day(s)`;
        } else if (hoursUntilStart >= 1) {
            document.getElementById('detailTimeRemaining').textContent = `Starts in ${Math.floor(hoursUntilStart)} hr ${Math.round((hoursUntilStart % 1) * 60)} min`;
        } else {
            document.getElementById('detailTimeRemaining').textContent = `Starts in ${Math.round(hoursUntilStart * 60)} minutes`;
        }
    } else if (start <= now && end >= now) {
        document.getElementById('detailTimeRemaining').textContent = 'üî¥ Currently Active';
    } else {
        document.getElementById('detailTimeRemaining').textContent = '';
    }
    
    // Cancellation section logic
    document.getElementById('cancellationEnabled').classList.add('hidden');
    document.getElementById('cancellationBlocked').classList.add('hidden');
    document.getElementById('alreadyCancelledSection').classList.add('hidden');
    document.getElementById('completedSection').classList.add('hidden');
    
    if (r.status === 'cancelled') {
        document.getElementById('alreadyCancelledSection').classList.remove('hidden');
        if (r.refundAmount > 0) {
            const refundMethod = r.refundMethod || 'UPI';
            document.getElementById('refundedAmount').textContent = `Refund of ‚Çπ${r.refundAmount.toFixed(2)} via ${refundMethod} has been processed`;
        }
    } else if (statusDisplay === 'completed' || end < now) {
        document.getElementById('completedSection').classList.remove('hidden');
    } else if (r.status === 'confirmed' && hoursUntilStart >= 1) {
        // Can cancel - more than 1 hour until start
        document.getElementById('cancellationEnabled').classList.remove('hidden');
    } else if (r.status === 'confirmed' && hoursUntilStart < 1) {
        // Cannot cancel - less than 1 hour until start
        document.getElementById('cancellationBlocked').classList.remove('hidden');
        if (hoursUntilStart > 0) {
            document.getElementById('blockedReason').textContent = `Only ${Math.round(hoursUntilStart * 60)} minutes until start time`;
        } else {
            document.getElementById('blockedReason').textContent = 'Reservation has already started';
        }
    } else {
        // Active or other status - cannot cancel
        document.getElementById('cancellationBlocked').classList.remove('hidden');
        document.getElementById('blockedReason').textContent = 'Cancellation not available for this status';
    }
    
    document.getElementById('detailModal').classList.remove('hidden');
}

function closeDetailModal() {
    document.getElementById('detailModal').classList.add('hidden');
    selectedReservation = null;
}

let selectedRefundMethod = 'UPI';

// Add event listeners for refund method radio buttons
document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('input[name="refundMethod"]').forEach(radio => {
        radio.addEventListener('change', function() {
            selectedRefundMethod = this.value;
            // Update visual selection
            document.querySelectorAll('.refund-option').forEach(label => {
                label.classList.remove('border-2', 'border-primary-500');
                label.classList.add('border', 'border-gray-200');
            });
            this.closest('.refund-option').classList.remove('border', 'border-gray-200');
            this.closest('.refund-option').classList.add('border-2', 'border-primary-500');
            // Toggle UPI input
            toggleUpiInput();
        });
    });
});

// Toggle UPI ID input visibility based on selected refund method
function toggleUpiInput() {
    const selectedRadio = document.querySelector('input[name="refundMethod"]:checked');
    const upiSection = document.getElementById('upiIdSection');
    if (upiSection) {
        if (selectedRadio && selectedRadio.value === 'UPI') {
            upiSection.style.display = 'block';
        } else {
            upiSection.style.display = 'none';
        }
    }
}

let refundUpiId = '';

function cancelFromDetail() {
    if (!selectedReservation) {
        console.error('No reservation selected');
        return;
    }
    
    // Store reservation data BEFORE closing modal (which clears selectedReservation)
    const reservationId = selectedReservation.id;
    const totalAmount = selectedReservation.totalAmount || 0;
    
    // Get selected refund method from radio buttons
    const selectedRadio = document.querySelector('input[name="refundMethod"]:checked');
    selectedRefundMethod = selectedRadio ? selectedRadio.value : 'UPI';
    
    // If UPI selected, validate and get UPI ID
    if (selectedRefundMethod === 'UPI') {
        const upiInput = document.getElementById('refundUpiId');
        if (!upiInput || !upiInput.value.trim()) {
            showToast('Please enter your UPI ID for the refund', 'warning');
            upiInput?.focus();
            return;
        }
        // Basic UPI validation (should contain @@)
        if (!upiInput.value.includes('@@')) {
            showToast('Please enter a valid UPI ID (e.g., yourname@upi)', 'error');
            upiInput.focus();
            return;
        }
        refundUpiId = upiInput.value.trim();
    } else {
        refundUpiId = '';
    }
    
    // Close detail modal (this sets selectedReservation to null)
    closeDetailModal();
    
    // Open cancel confirmation with stored values
    openCancelModal(reservationId, totalAmount);
}

function openCancelModal(reservationId, totalAmount) {
    reservationToCancel = reservationId;
    const reservation = allReservations.find(r => r.id === reservationId);
    const refundAmount = (totalAmount * 0.90).toFixed(2); // 10% fee
    
    // Show full reservation details in modal
    if (reservation) {
        const start = new Date(reservation.startTime);
        const end = new Date(reservation.endTime);
        document.getElementById('cancelModalText').innerHTML = `
            <div class="text-left space-y-2">
                <p><strong>Location:</strong> ${reservation.locationName || 'N/A'}</p>
                <p><strong>Slot:</strong> ${reservation.slotCode || 'N/A'}</p>
                <p><strong>Date:</strong> ${start.toLocaleDateString()}</p>
                <p><strong>Time:</strong> ${start.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'})} - ${end.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'})}</p>
                <p><strong>Vehicle:</strong> ${reservation.vehiclePlate || 'N/A'}</p>
                <p><strong>Amount Paid:</strong> ‚Çπ${totalAmount.toFixed(2)}</p>
                <p class="mt-2 pt-2 border-t"><strong>Refund via:</strong> <span class="text-primary-600 font-semibold">${selectedRefundMethod}</span></p>
            </div>
        `;
    }
    
    document.getElementById('refundPreview').textContent = `‚Çπ${refundAmount}`;
    document.getElementById('cancelModal').classList.remove('hidden');
}

function closeCancelModal() {
    document.getElementById('cancelModal').classList.add('hidden');
    reservationToCancel = null;
}

async function confirmCancel() {
    if (!reservationToCancel) return;
    
    const btn = document.getElementById('confirmCancelBtn');
    btn.disabled = true;
    btn.textContent = 'Processing...';
    
    try {
        const requestBody = { 
            refundMethod: selectedRefundMethod,
            refundUpiId: refundUpiId || null
        };
        
        console.log('[CANCEL] Sending:', requestBody);
        
        const response = await Auth.apiRequest(`/api/reservation/${reservationToCancel}/cancel`, {
            method: 'POST',
            body: JSON.stringify(requestBody)
        });
        const data = await response.json();
        
        if (data.success) {
            // Show success with refund details
            const refundMethod = data.data?.refundMethod || selectedRefundMethod;
            const refundAmount = data.data?.refundAmount || 0;
            const upiId = data.data?.refundUpiId || refundUpiId;
            
            let successMsg = `‚úÖ ${data.message}\n\nRefund of ‚Çπ${refundAmount.toFixed(2)} will be processed via ${refundMethod}`;
            if (refundMethod === 'UPI' && upiId) {
                successMsg += `\nUPI ID: ${upiId}`;
            }
            
            showToast(successMsg.replace('‚úÖ ', ''), 'success', 6000);
            closeCancelModal();
            await loadReservations();
        } else {
            showToast(data.message, 'error');
        }
    } catch (error) {
        console.error('Cancel error:', error);
        showToast('Failed to cancel reservation', 'error');
    } finally {
        btn.disabled = false;
        btn.textContent = 'Cancel & Refund';
    }
}
</script>
}
