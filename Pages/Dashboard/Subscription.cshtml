@page
@model Stationnement.Web.Pages.Dashboard.SubscriptionModel
@{
    ViewData["Title"] = "Subscription";
    Layout = "_DashboardLayout";
}

<div class="flex items-center justify-between mb-6">
    <div>
        <h2 class="text-xl font-semibold text-gray-900">My Subscription</h2>
        <p class="text-gray-500">Manage your parking subscription and unlock premium features</p>
    </div>
</div>

<!-- Current Plan -->
<div class="bg-white rounded-xl shadow-sm p-6 mb-6" id="currentPlanCard">
    <div class="flex items-center justify-between mb-4">
        <div class="flex items-center gap-3">
            <div id="currentPlanBadge" class="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg font-semibold">
                Free Plan
            </div>
            <span id="currentPlanStatus" class="text-sm text-gray-500">Loading...</span>
        </div>
        <div class="flex items-center gap-3">
            <span id="expiresAt" class="text-sm text-gray-500"></span>
            <button id="cancelSubBtn" onclick="cancelSubscription()" class="hidden px-4 py-2 text-sm text-red-600 border border-red-200 rounded-lg hover:bg-red-50">
                Cancel Subscription
            </button>
        </div>
    </div>
    <p id="currentPlanDesc" class="text-gray-600">Loading subscription details...</p>
</div>

<!-- Subscription Tiers -->
<h3 class="text-lg font-semibold text-gray-900 mb-4">Choose Your Plan</h3>
<div class="grid md:grid-cols-4 gap-6" id="tiersGrid">
    <!-- Tiers will be loaded dynamically -->
</div>

<!-- UPI Payment Modal -->
<div id="paymentModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-2xl p-6 max-w-md w-full mx-4">
        <h3 class="text-xl font-bold text-gray-900 mb-2">Subscribe to <span id="paymentTierName">Pro</span></h3>
        <p class="text-gray-500 mb-4">Scan the QR code with any UPI app to complete payment</p>
        
        <div class="bg-gray-50 rounded-xl p-6 mb-4">
            <div id="upiQrCode" class="w-48 h-48 mx-auto flex items-center justify-center">
                <div class="spinner"></div>
            </div>
            <p class="text-center mt-4 text-2xl font-bold text-gray-900">₹<span id="paymentAmount">0</span></p>
            <p class="text-center text-sm text-gray-500">Pay via GPay, PhonePe, Paytm, etc.</p>
        </div>
        
        <div class="flex gap-3">
            <button onclick="closePaymentModal()" class="flex-1 py-3 border border-gray-300 text-gray-700 rounded-lg font-medium hover:bg-gray-50">Cancel</button>
            <button onclick="confirmPayment()" id="confirmPaymentBtn" class="flex-1 py-3 bg-primary-600 text-white rounded-lg font-medium hover:bg-primary-700">I've Paid</button>
        </div>
    </div>
</div>

<!-- Cancel Confirmation Modal -->
<div id="cancelModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-2xl p-6 max-w-md w-full mx-4">
        <h3 class="text-lg font-semibold text-gray-900 mb-2">Cancel Subscription?</h3>
        <p class="text-gray-600 mb-4">Your subscription will remain active until the expiry date. After that, you'll be downgraded to the Free plan.</p>
        
        <div class="bg-amber-50 border border-amber-200 rounded-lg p-4 mb-4">
            <p class="text-sm text-amber-700">⚠️ You'll lose access to premium parking slots and discounts after cancellation.</p>
        </div>
        
        <div class="flex gap-3">
            <button onclick="closeCancelModal()" class="flex-1 py-3 border border-gray-300 text-gray-700 rounded-lg font-medium hover:bg-gray-50">Keep Subscription</button>
            <button onclick="confirmCancelSubscription()" id="confirmCancelBtn" class="flex-1 py-3 bg-red-600 text-white rounded-lg font-medium hover:bg-red-700">Cancel Subscription</button>
        </div>
    </div>
</div>

@section Scripts {
<script>
let currentSubscription = null;
let selectedTierId = null;
let selectedTierPrice = 0;

document.addEventListener('DOMContentLoaded', async function() {
    await loadCurrentSubscription();
    await loadTiers();
});

async function loadCurrentSubscription() {
    try {
        const response = await Auth.apiRequest('/api/subscription/current');
        const data = await response.json();
        
        if (data.success) {
            currentSubscription = data.data;
            updateCurrentPlanUI(data.data);
        }
    } catch (error) {
        console.error('Error loading subscription:', error);
    }
}

function updateCurrentPlanUI(sub) {
    const badge = document.getElementById('currentPlanBadge');
    const status = document.getElementById('currentPlanStatus');
    const desc = document.getElementById('currentPlanDesc');
    const expires = document.getElementById('expiresAt');
    const card = document.getElementById('currentPlanCard');
    const cancelBtn = document.getElementById('cancelSubBtn');
    
    const tierInfo = sub.tierInfo;
    badge.textContent = tierInfo.name + ' Plan';
    
    // Show cancel button for paid subscriptions
    if (sub.tier !== 'free' && sub.isActive) {
        cancelBtn.classList.remove('hidden');
    } else {
        cancelBtn.classList.add('hidden');
    }
    
    // Color based on tier
    if (sub.tier === 'premium_plus') {
        badge.className = 'px-4 py-2 bg-gradient-to-r from-amber-500 to-orange-500 text-white rounded-lg font-semibold';
        card.className = 'bg-gradient-to-br from-amber-50 to-orange-50 rounded-xl shadow-sm p-6 mb-6 border-2 border-amber-300';
    } else if (sub.tier === 'pro') {
        badge.className = 'px-4 py-2 bg-primary-600 text-white rounded-lg font-semibold';
        card.className = 'bg-primary-50 rounded-xl shadow-sm p-6 mb-6 border-2 border-primary-300';
    } else if (sub.tier === 'basic') {
        badge.className = 'px-4 py-2 bg-blue-100 text-blue-700 rounded-lg font-semibold';
        card.className = 'bg-white rounded-xl shadow-sm p-6 mb-6';
    } else {
        badge.className = 'px-4 py-2 bg-gray-100 text-gray-700 rounded-lg font-semibold';
        card.className = 'bg-white rounded-xl shadow-sm p-6 mb-6';
    }
    
    status.textContent = sub.isActive ? '✓ Active' : 'Inactive';
    status.className = sub.isActive ? 'text-sm text-green-600 font-medium' : 'text-sm text-red-600';
    
    if (sub.expiresAt) {
        const expDate = new Date(sub.expiresAt).toLocaleDateString();
        expires.textContent = `Expires: ${expDate}`;
    }
    
    // Features description
    if (tierInfo.features && tierInfo.features.length > 0) {
        desc.innerHTML = tierInfo.features.map(f => 
            `<span class="inline-flex items-center mr-4 mb-2"><svg class="w-4 h-4 text-green-500 mr-1" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/></svg>${f}</span>`
        ).join('');
    }
}

async function loadTiers() {
    try {
        const response = await fetch('/api/subscription/tiers');
        const data = await response.json();
        
        if (data.success) {
            renderTiers(data.data);
        }
    } catch (error) {
        console.error('Error loading tiers:', error);
    }
}

function renderTiers(tiers) {
    const grid = document.getElementById('tiersGrid');
    
    grid.innerHTML = tiers.map(tier => {
        const isCurrent = currentSubscription && currentSubscription.tier === tier.id;
        const isPopular = tier.id === 'pro';
        const isPremiumPlus = tier.id === 'premium_plus';
        
        let borderClass = 'border border-gray-200';
        if (isCurrent) borderClass = 'border-2 border-green-500';
        else if (isPremiumPlus) borderClass = 'border-2 border-amber-400';
        else if (isPopular) borderClass = 'border-2 border-primary-500';
        
        return `
        <div class="bg-white rounded-xl shadow-sm p-6 ${borderClass} relative ${isPremiumPlus ? 'bg-gradient-to-br from-amber-50 to-orange-50' : ''}">
            ${isPopular ? '<span class="absolute -top-3 left-1/2 -translate-x-1/2 bg-primary-600 text-white text-xs font-medium px-3 py-1 rounded-full">Popular</span>' : ''}
            ${isPremiumPlus ? '<span class="absolute -top-3 left-1/2 -translate-x-1/2 bg-gradient-to-r from-amber-500 to-orange-500 text-white text-xs font-medium px-3 py-1 rounded-full flex items-center gap-1"><svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/></svg>Premium</span>' : ''}
            ${isCurrent ? '<span class="absolute -top-3 right-4 bg-green-500 text-white text-xs font-medium px-3 py-1 rounded-full">Current</span>' : ''}
            
            <h4 class="text-xl font-bold ${isPremiumPlus ? 'text-amber-700' : 'text-gray-900'} mb-2 mt-2">${tier.name}</h4>
            <p class="text-3xl font-bold ${isPremiumPlus ? 'text-amber-600' : 'text-gray-900'} mb-1">
                ${tier.pricePerMonth === 0 ? 'Free' : '₹' + tier.pricePerMonth}
                ${tier.pricePerMonth > 0 ? '<span class="text-lg font-normal text-gray-500">/mo</span>' : ''}
            </p>
            <p class="text-sm text-gray-500 mb-4">${tier.discount > 0 ? (tier.discount * 100) + '% discount on all bookings' : 'Pay as you go'}</p>
            
            <ul class="space-y-2 mb-6 text-sm">
                ${tier.features.map(f => `
                    <li class="flex items-start">
                        <svg class="w-4 h-4 ${isPremiumPlus ? 'text-amber-500' : 'text-green-500'} mr-2 mt-0.5 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                        </svg>
                        <span class="text-gray-600">${f}</span>
                    </li>
                `).join('')}
                ${tier.canAccessPremiumSlots ? `
                    <li class="flex items-start">
                        <svg class="w-4 h-4 text-amber-500 mr-2 mt-0.5 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/>
                        </svg>
                        <span class="text-amber-700 font-medium">Premium Parking Slots</span>
                    </li>
                ` : ''}
            </ul>
            
            ${isCurrent ? 
                `<button disabled class="w-full py-3 bg-green-100 text-green-700 rounded-lg font-medium cursor-not-allowed">Current Plan</button>` :
                tier.id === 'free' ?
                    `<button disabled class="w-full py-3 bg-gray-100 text-gray-500 rounded-lg font-medium cursor-not-allowed">Default Plan</button>` :
                    `<button onclick="openPaymentModal('${tier.id}', '${tier.name}', ${tier.pricePerMonth})" class="w-full py-3 ${isPremiumPlus ? 'bg-gradient-to-r from-amber-500 to-orange-500 hover:from-amber-600 hover:to-orange-600' : isPopular ? 'bg-primary-600 hover:bg-primary-700' : 'bg-gray-800 hover:bg-gray-900'} text-white rounded-lg font-medium transition">
                        Subscribe
                    </button>`
            }
        </div>
        `;
    }).join('');
}

async function openPaymentModal(tierId, tierName, price) {
    selectedTierId = tierId;
    selectedTierPrice = price;
    
    document.getElementById('paymentTierName').textContent = tierName;
    document.getElementById('paymentAmount').textContent = price;
    document.getElementById('paymentModal').classList.remove('hidden');
    
    // Generate UPI QR code
    try {
        const response = await fetch('/api/payment/generate-upi-qr', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                amount: price,
                transactionId: `SUB-${tierId}-${Date.now()}`,
                note: `${tierName} Subscription`
            })
        });
        
        const data = await response.json();
        if (data.success) {
            document.getElementById('upiQrCode').innerHTML = `<img src="${data.data.qrCodeBase64}" alt="UPI QR" class="w-48 h-48" />`;
        }
    } catch (error) {
        console.error('Error generating QR:', error);
    }
}

function closePaymentModal() {
    document.getElementById('paymentModal').classList.add('hidden');
    selectedTierId = null;
}

async function confirmPayment() {
    if (!selectedTierId) return;
    
    const btn = document.getElementById('confirmPaymentBtn');
    btn.disabled = true;
    btn.textContent = 'Processing...';
    
    try {
        const response = await Auth.apiRequest('/api/subscription/activate', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ tier: selectedTierId })
        });
        
        const data = await response.json();
        
        if (data.success) {
            closePaymentModal();
            showToast(`${data.message} - Your subscription is now active!`, 'success', 5000);
            await loadCurrentSubscription();
            await loadTiers();
        } else {
            showToast(data.message, 'error');
        }
    } catch (error) {
        console.error('Activation error:', error);
        showToast('Failed to activate subscription', 'error');
    } finally {
        btn.disabled = false;
        btn.textContent = "I've Paid";
    }
}

function cancelSubscription() {
    document.getElementById('cancelModal').classList.remove('hidden');
}

function closeCancelModal() {
    document.getElementById('cancelModal').classList.add('hidden');
}

async function confirmCancelSubscription() {
    const btn = document.getElementById('confirmCancelBtn');
    btn.disabled = true;
    btn.textContent = 'Cancelling...';
    
    try {
        const response = await Auth.apiRequest('/api/subscription/cancel', {
            method: 'POST'
        });
        
        const data = await response.json();
        
        if (data.success) {
            closeCancelModal();
            showToast('Subscription cancelled. You can continue using premium features until the expiry date.', 'success');
            await loadCurrentSubscription();
            await loadTiers();
        } else {
            showToast(data.message, 'error');
        }
    } catch (error) {
        console.error('Cancel error:', error);
        showToast('Failed to cancel subscription', 'error');
    } finally {
        btn.disabled = false;
        btn.textContent = 'Cancel Subscription';
    }
}
</script>
}
