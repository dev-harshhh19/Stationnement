@page
@model Stationnement.Web.Pages.Dashboard.PaymentsModel
@{
    ViewData["Title"] = "Payment History";
    Layout = "_DashboardLayout";
}

<div class="flex items-center justify-between mb-6">
    <div>
        <h2 class="text-xl font-semibold text-gray-900">Payment History</h2>
        <p class="text-gray-500">View your transactions and receipts</p>
    </div>
</div>

<!-- Stats -->
<div class="grid md:grid-cols-3 gap-4 mb-6">
    <div class="bg-white rounded-xl p-6 shadow-sm">
        <p class="text-sm text-gray-500">Total Spent</p>
        <p class="text-2xl font-bold text-gray-900" id="totalSpent">Rs.0.00</p>
    </div>
    <div class="bg-white rounded-xl p-6 shadow-sm">
        <p class="text-sm text-gray-500">This Month</p>
        <p class="text-2xl font-bold text-gray-900" id="thisMonth">Rs.0.00</p>
    </div>
    <div class="bg-white rounded-xl p-6 shadow-sm">
        <p class="text-sm text-gray-500">Transactions</p>
        <p class="text-2xl font-bold text-gray-900" id="transactionCount">0</p>
    </div>
</div>

<!-- Payments List -->
<div class="bg-white rounded-xl shadow-sm overflow-hidden">
    <div class="overflow-x-auto">
        <table class="w-full min-w-[600px]">
            <thead class="bg-gray-50">
                <tr>
                    <th class="px-4 lg:px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase">Date</th>
                    <th class="px-4 lg:px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase">Description</th>
                    <th class="px-4 lg:px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase">Amount</th>
                    <th class="px-4 lg:px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                    <th class="px-4 lg:px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase">Receipt</th>
                </tr>
            </thead>
            <tbody id="paymentsTable" class="divide-y divide-gray-200">
                <tr><td colspan="5" class="px-6 py-8 text-center text-gray-500">Loading payments...</td></tr>
            </tbody>
        </table>
    </div>
</div>

@section Scripts {
<script>
document.addEventListener('DOMContentLoaded', loadPayments);

async function loadPayments() {
    const tbody = document.getElementById('paymentsTable');
    
    try {
        const response = await Auth.apiRequest('/api/payment');
        const data = await response.json();
        
        let payments = [];
        
        if (data.success && data.data && data.data.length > 0) {
            // Use payment records if available
            payments = data.data.map(p => ({
                id: p.id,
                date: p.createdAt,
                description: p.reservationDetails 
                    ? `${p.reservationDetails.locationName || 'Parking'} - Slot ${p.reservationDetails.slotCode || 'N/A'}`
                    : 'Parking Payment',
                amount: p.amount,
                status: p.status,
                transactionId: p.transactionId,
                location: p.reservationDetails?.locationName || 'Parking Location',
                slot: p.reservationDetails?.slotCode || 'Standard',
                reservationDate: p.reservationDetails?.startTime ? new Date(p.reservationDetails.startTime).toLocaleDateString('en-IN') : new Date(p.createdAt).toLocaleDateString('en-IN')
            }));
        } else {
            // Fallback: Show payments from reservations if no payment records exist
            try {
                const resResponse = await Auth.apiRequest('/api/reservation');
                const resData = await resResponse.json();
                
                if (resData.success && resData.data) {
                    payments = resData.data
                        .filter(r => r.id && r.totalAmount > 0)
                        .map(r => ({
                            id: r.id,
                            date: r.startTime || r.createdAt,
                            description: `${r.locationName || 'Parking'} - Slot ${r.slotCode || 'N/A'}`,
                            amount: r.totalAmount,
                            status: r.status === 'completed' ? 'completed' : r.status === 'active' ? 'active' : 'confirmed',
                            transactionId: `STN-${r.id.toString().substring(0, 8).toUpperCase()}`,
                            location: r.locationName || 'Parking Location',
                            slot: r.slotCode || 'Standard',
                            reservationDate: r.startTime ? new Date(r.startTime).toLocaleDateString('en-IN') : new Date(r.createdAt).toLocaleDateString('en-IN')
                        }));
                }
            } catch (fallbackError) {
                console.error('Fallback payment load error:', fallbackError);
            }
        }
        
        // Separate payments: paid vs truly pending
        // "confirmed" = payment confirmed/paid (should be counted in totals)
        // "completed" = payment and reservation completed
        // "active" = reservation is active (payment was made)
        // "pending"/"processing" = payment not yet processed
        const paidPayments = payments.filter(p => {
            const status = (p.status || '').toLowerCase();
            return status === 'completed' || status === 'confirmed' || status === 'active';
        });
        const pendingPayments = payments.filter(p => {
            const status = (p.status || '').toLowerCase();
            return status === 'pending' || status === 'processing';
        });

        // Calculate totals from ALL paid payments (confirmed + completed + active)
        const total = paidPayments.reduce((sum, p) => sum + p.amount, 0);
        
        // This month's paid payments
        const now = new Date();
        const thisMonthPayments = paidPayments.filter(p => {
            const pDate = new Date(p.date);
            return pDate.getMonth() === now.getMonth() && pDate.getFullYear() === now.getFullYear();
        });
        const thisMonthTotal = thisMonthPayments.reduce((sum, p) => sum + p.amount, 0);
        
        document.getElementById('totalSpent').textContent = `Rs.${total.toFixed(2)}`;
        document.getElementById('thisMonth').textContent = `Rs.${thisMonthTotal.toFixed(2)}`;
        document.getElementById('transactionCount').textContent = paidPayments.length;

        if (payments.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5" class="px-6 py-8 text-center text-gray-500">No payments found</td></tr>';
            return;
        }

        let html = '';
        
        // Show pending payments first if any (only truly pending - not paid yet)
        if (pendingPayments.length > 0) {
            html += `<tr class="bg-amber-50"><td colspan="5" class="px-6 py-3 text-amber-700 font-semibold text-sm uppercase">Pending Payments</td></tr>`;
            html += pendingPayments.map(p => `
                <tr class="hover:bg-gray-50">
                    <td class="px-6 py-4 text-gray-900">${new Date(p.date).toLocaleDateString('en-IN')}</td>
                    <td class="px-6 py-4 text-gray-600">${p.description}</td>
                    <td class="px-6 py-4 font-medium text-gray-900">Rs.${p.amount.toFixed(2)}</td>
                    <td class="px-6 py-4">
                        <span class="px-2 py-1 text-xs font-medium rounded-full bg-yellow-100 text-yellow-700">${p.status}</span>
                    </td>
                    <td class="px-6 py-4">
                        <span class="text-xs text-gray-400 font-mono">${p.transactionId}</span>
                    </td>
                </tr>
            `).join('');
        }
        
        // Show paid payments (confirmed, completed, active) - these are the main payments
        // Note: "confirmed" payments are shown here because payment is confirmed/paid
        if (paidPayments.length > 0) {
            // Only show section header if there are pending payments above, or if this is the only section
            if (pendingPayments.length > 0) {
                html += `<tr class="bg-gray-50"><td colspan="5" class="px-6 py-3 text-gray-700 font-semibold text-sm uppercase">Completed Payments</td></tr>`;
            } else if (paidPayments.length > 0) {
                // If no pending payments, we can optionally show a header, but it's cleaner without
                // html += `<tr class="bg-gray-50"><td colspan="5" class="px-6 py-3 text-gray-700 font-semibold text-sm uppercase">Payment History</td></tr>`;
            }
            
            html += paidPayments.map(p => {
                const status = (p.status || '').toLowerCase();
                const statusClass = status === 'completed' 
                    ? 'bg-green-100 text-green-700' 
                    : status === 'active'
                    ? 'bg-blue-100 text-blue-700'
                    : 'bg-yellow-100 text-yellow-700'; // confirmed status
                
                const statusDisplay = status === 'completed' ? 'Completed' 
                    : status === 'active' ? 'Active' 
                    : 'Confirmed';
                
                return `
                <tr class="hover:bg-gray-50">
                    <td class="px-6 py-4 text-gray-900">${new Date(p.date).toLocaleDateString('en-IN')}</td>
                    <td class="px-6 py-4 text-gray-600">${p.description}</td>
                    <td class="px-6 py-4 font-medium text-gray-900">Rs.${p.amount.toFixed(2)}</td>
                    <td class="px-6 py-4">
                        <span class="px-2 py-1 text-xs font-medium rounded-full ${statusClass}">${statusDisplay}</span>
                    </td>
                    <td class="px-6 py-4">
                        <a href="/api/payment/receipt/${p.id}?location=${encodeURIComponent(p.location)}&date=${encodeURIComponent(p.reservationDate)}&amount=${p.amount}&slot=${encodeURIComponent(p.slot)}&transactionId=${encodeURIComponent(p.transactionId)}" 
                           target="_blank"
                           class="inline-flex items-center gap-1 text-primary-600 hover:text-primary-700 text-sm font-medium hover:underline">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                            </svg>
                            Download
                        </a>
                    </td>
                </tr>
            `;
            }).join('');
        }
        
        tbody.innerHTML = html;
    } catch (error) {
        console.error('Error loading payments:', error);
        tbody.innerHTML = '<tr><td colspan="5" class="px-6 py-8 text-center text-gray-500">Error loading payments</td></tr>';
    }
}
</script>
}
